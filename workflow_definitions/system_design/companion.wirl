workflow SystemDesignCompanion {
  inputs {
    String chat_input
    String workspace_id
    String version_id
    Bool remove_solutions
  }
  
  outputs {
    String final_version_id = SaveState.final_version_id?
  }

  node LoadWorkspace {
      call load_workspace_state
      inputs {
          String workspace_id = workspace_id
          String version_id = version_id
      }
      outputs {
         Record problem_space
         Record solution_space
      }
  }

  node ExtractProblem {
      call extract_problem
      inputs {
          String chat_input = chat_input
          Record current_problem = LoadWorkspace.problem_space
      }
      const {
        model: "gpt-oss:20b"
      }
      outputs {
          Record new_problem_space
          Bool has_changes
      }
  }

  node CheckProblemSpace {
      call check_problem_space
      inputs {
          Record problem_space = ExtractProblem.new_problem_space
      }
      const {
        model: "gpt-oss:20b"
      }
      outputs {
          List<String> observations
      }
  }

  node RefineProblemSpace {
      call refine_problem_space
      inputs {
          Record current_problem = ExtractProblem.new_problem_space
          String chat_input = chat_input
          List<String> observations = CheckProblemSpace.observations
          Bool previous_has_changes = ExtractProblem.has_changes
      }
      const {
        model: "gpt-oss:20b"
      }
      outputs {
          Record new_problem_space
          Bool has_changes
      }
  }

  node SaveState {
      call save_state
      inputs {
          Record problem_space = RefineProblemSpace.new_problem_space
          String workspace_id = workspace_id
          Bool has_changes = RefineProblemSpace.has_changes
          
          Record solution_space = LoadWorkspace.solution_space
          Bool remove_solutions = remove_solutions
      }
      outputs {
          String final_version_id
      }
  }
}
